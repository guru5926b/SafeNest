rules_version = '2';

service cloud.firestore { match /databases/{database}/documents {

// Rule: Users can read and write their own profile document.
match /users/{userId} {
  allow read, write: if request.auth != null && request.auth.uid == userId;
}

// Rule: Any authenticated user can get the profile of another user.
// This is necessary to display names in the family list.
match /users/{userId} {
  allow get: if request.auth != null;
}

// Rule: Only members of a family can read or update their family document.
match /families/{familyId} {
  allow read, update: if request.auth != null && resource.data.members.hasAny([request.auth.uid]);
}

// CRITICAL RULE: Only a member of a family can send their location to that family's 
// private location collection. Any member of that same family is allowed to read the locations.
match /families/{familyId}/locations/{userId} {
  allow read, write, delete: if request.auth != null && get(/databases/$(database)/documents/families/$(familyId)).data.members.hasAny([request.auth.uid]);
}

} }

